<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ Plataformas 3D - Mejorado</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        #gameCanvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        #ui {
            position: fixed;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            z-index: 100;
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 15px;
        }

        #powerups {
            position: fixed;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 18px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            z-index: 100;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 15px;
            min-width: 200px;
        }

        .powerup-active {
            display: flex;
            align-items: center;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 8px;
        }

        .powerup-timer {
            margin-left: auto;
            font-size: 14px;
            color: #fbbf24;
        }

        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 30px;
            border-radius: 15px;
            text-align: center;
            font-size: 16px;
        }

        #gameOver {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 50px;
            border-radius: 25px;
            color: white;
            text-align: center;
            display: none;
            z-index: 200;
            border: 4px solid #fbbf24;
        }

        #gameOver h1 {
            font-size: 56px;
            margin-bottom: 20px;
            color: #fbbf24;
        }

        #gameOver button {
            margin: 10px;
            padding: 15px 40px;
            font-size: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        #gameOver button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.8);
        }

        .stat {
            margin: 10px 0;
        }

        #startScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 300;
        }

        #startScreen h1 {
            font-size: 72px;
            color: white;
            margin-bottom: 30px;
            text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.5);
        }

        #startScreen button {
            padding: 20px 50px;
            font-size: 28px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        #startScreen button:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }

        #startScreen p {
            color: white;
            font-size: 18px;
            margin-top: 30px;
            text-align: center;
            max-width: 600px;
        }

        .powerup-info {
            font-size: 14px;
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>

    <div id="startScreen">
        <h1>üéÆ Plataformas 3D</h1>
        <button onclick="startGame()">JUGAR</button>
        <p>
            <strong>WASD</strong> - Mover | <strong>ESPACIO</strong> - Saltar<br>
            Recoge las monedas y llega a la meta sin caerte
        </p>
        <div class="powerup-info">
            <strong>Power-ups:</strong><br>
            ‚ö° Velocidad | ü¶ò Super Salto | üõ°Ô∏è Escudo | ‚≠ê Invencibilidad
        </div>
    </div>

    <div id="ui">
        <div class="stat">ü™ô Monedas: <span id="coins">0</span></div>
        <div class="stat">‚ù§Ô∏è Vidas: <span id="lives">3</span></div>
        <div class="stat">üìç Nivel: <span id="level">1</span>/7</div>
        <div class="stat">‚è±Ô∏è Tiempo: <span id="time">0</span>s</div>
    </div>

    <div id="powerups">
        <div style="margin-bottom: 10px; font-size: 20px;">‚ö° Power-ups</div>
        <div id="activePowerups"></div>
    </div>

    <div id="controls">
        <strong>WASD</strong> = Mover | <strong>ESPACIO</strong> = Saltar | <strong>MOUSE</strong> = Mirar
    </div>

    <div id="gameOver">
        <h1 id="gameOverTitle">¬°Game Over!</h1>
        <p id="gameOverText"></p>
        <div style="margin: 20px 0;">
            <div class="stat">ü™ô Monedas: <span id="finalCoins">0</span></div>
            <div class="stat">‚è±Ô∏è Tiempo: <span id="finalTime">0</span>s</div>
        </div>
        <button onclick="restartGame()">üîÑ Reintentar</button>
        <button onclick="location.reload()">üè† Men√∫</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Configuraci√≥n
        let scene, camera, renderer;
        let player, playerVelocity = new THREE.Vector3();
        let platforms = [];
        let coins = [];
        let enemies = [];
        let powerups = [];
        let keys = {};
        let gameActive = false;
        let isJumping = false;
        let canJump = false;
        
        // Stats
        let coinsCollected = 0;
        let lives = 3;
        let currentLevel = 1;
        let startTime = 0;
        let elapsedTime = 0;

        // Power-ups activos
        let activePowerups = {
            speed: { active: false, endTime: 0 },
            jump: { active: false, endTime: 0 },
            shield: { active: false, endTime: 0 },
            invincible: { active: false, endTime: 0 }
        };

        // F√≠sicas (velocidad reducida)
        const gravity = -0.02;
        const baseJumpForce = 0.35;  // Reducido de 0.4
        const baseMoveSpeed = 0.10;  // Reducido de 0.15
        const friction = 0.88;       // Aumentado para m√°s control

        function getCurrentMoveSpeed() {
            return activePowerups.speed.active ? baseMoveSpeed * 1.8 : baseMoveSpeed;
        }

        function getCurrentJumpForce() {
            return activePowerups.jump.active ? baseJumpForce * 1.5 : baseJumpForce;
        }

        // Inicializar
        function init() {
            // Escena
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            scene.fog = new THREE.Fog(0x87ceeb, 10, 100);

            // C√°mara
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 10);

            // Renderer
            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('gameCanvas'), antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            // Luces
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 20, 10);
            directionalLight.castShadow = true;
            directionalLight.shadow.camera.left = -50;
            directionalLight.shadow.camera.right = 50;
            directionalLight.shadow.camera.top = 50;
            directionalLight.shadow.camera.bottom = -50;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);

            // Jugador
            const playerGeometry = new THREE.BoxGeometry(1, 1, 1);
            const playerMaterial = new THREE.MeshStandardMaterial({ color: 0x3b82f6 });
            player = new THREE.Mesh(playerGeometry, playerMaterial);
            player.position.set(0, 2, 0);
            player.castShadow = true;
            scene.add(player);

            // Crear nivel
            createLevel(currentLevel);

            // Eventos
            window.addEventListener('keydown', (e) => keys[e.key.toLowerCase()] = true);
            window.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);
            window.addEventListener('resize', onWindowResize);

            // Mouse para c√°mara
            let mouseX = 0;
            window.addEventListener('mousemove', (e) => {
                mouseX = (e.clientX / window.innerWidth) * 2 - 1;
            });

            // Actualizar c√°mara con mouse
            setInterval(() => {
                if (gameActive && player) {
                    camera.position.x = player.position.x + mouseX * 5;
                    camera.position.y = player.position.y + 5;
                    camera.position.z = player.position.z + 10;
                    camera.lookAt(player.position);
                }
            }, 16);
        }

        function createLevel(level) {
            // Limpiar nivel anterior
            platforms.forEach(p => scene.remove(p));
            coins.forEach(c => scene.remove(c));
            enemies.forEach(e => scene.remove(e));
            powerups.forEach(p => scene.remove(p));
            platforms = [];
            coins = [];
            enemies = [];
            powerups = [];

            // Plataforma inicial
            createPlatform(0, 0, 0, 4, 0.5, 4, 0x22c55e);

            if (level === 1) {
                // Nivel 1: Tutorial b√°sico con power-up
                createPlatform(5, 0, 0, 4, 0.5, 4, 0x3b82f6);
                createCoin(5, 2, 0);
                
                createPlatform(10, 1, 0, 4, 0.5, 4, 0x3b82f6);
                createCoin(10, 3, 0);
                createPowerup(10, 3.5, 0, 'speed');
                
                createPlatform(15, 0.5, 0, 4, 0.5, 4, 0x3b82f6);
                createCoin(15, 2.5, 0);
                
                createPlatform(20, 2, 0, 4, 0.5, 4, 0x3b82f6);
                createCoin(20, 4, 0);
                
                createGoal(25, 2, 0);
            } else if (level === 2) {
                // Nivel 2: Saltos con super salto
                createPlatform(6, 1, 0, 3, 0.5, 3, 0x3b82f6);
                createCoin(6, 3, 0);
                
                createPlatform(11, 2, 2, 3, 0.5, 3, 0x8b5cf6);
                createCoin(11, 4, 2);
                createPowerup(11, 4.5, 2, 'jump');
                
                createPlatform(16, 4, -2, 3, 0.5, 3, 0x8b5cf6);
                createCoin(16, 6, -2);
                
                createPlatform(21, 3, 0, 3, 0.5, 3, 0x3b82f6);
                createEnemy(21, 4, 0);
                
                createPlatform(26, 5, 0, 4, 0.5, 4, 0x3b82f6);
                createCoin(26, 7, 0);
                
                createGoal(31, 5, 0);
            } else if (level === 3) {
                // Nivel 3: Plataformas m√≥viles y escudo
                createPlatform(5, 0, 0, 3, 0.5, 3, 0x3b82f6);
                createEnemy(5, 1.5, 0);
                createPowerup(5, 2, 0, 'shield');
                
                createMovingPlatform(10, 2, 0, 3, 0.5, 3, 0xfbbf24, 'x', 3);
                createCoin(10, 4, 0);
                
                createPlatform(15, 3, 3, 3, 0.5, 3, 0x8b5cf6);
                createCoin(15, 5, 3);
                
                createMovingPlatform(20, 2, 0, 3, 0.5, 3, 0xfbbf24, 'y', 2);
                createCoin(20, 4, 0);
                createEnemy(20, 5, 0);
                
                createPlatform(25, 4, -3, 3, 0.5, 3, 0x8b5cf6);
                createEnemy(25, 5.5, -3);
                
                createPlatform(30, 5, 0, 4, 0.5, 4, 0x3b82f6);
                createCoin(30, 7, 0);
                createCoin(30, 7, 2);
                createCoin(30, 7, -2);
                
                createGoal(36, 5, 0);
            } else if (level === 4) {
                // Nivel 4: Zigzag con enemigos
                createPlatform(5, 1, 3, 3, 0.5, 3, 0x3b82f6);
                createCoin(5, 3, 3);
                createEnemy(5, 2.5, 3);
                
                createPlatform(10, 2, -3, 3, 0.5, 3, 0x8b5cf6);
                createCoin(10, 4, -3);
                createPowerup(10, 4.5, -3, 'invincible');
                
                createPlatform(15, 3, 3, 3, 0.5, 3, 0x3b82f6);
                createEnemy(15, 4.5, 3);
                
                createPlatform(20, 4, -3, 3, 0.5, 3, 0x8b5cf6);
                createCoin(20, 6, -3);
                createEnemy(20, 5.5, -3);
                
                createMovingPlatform(25, 3, 0, 3, 0.5, 3, 0xfbbf24, 'z', 3);
                createCoin(25, 5, 0);
                
                createPlatform(30, 5, 0, 4, 0.5, 4, 0x3b82f6);
                createGoal(35, 5, 0);
            } else if (level === 5) {
                // Nivel 5: Plataformas estrechas
                createPlatform(4, 1, 0, 2, 0.5, 2, 0x3b82f6);
                createCoin(4, 3, 0);
                
                createPlatform(8, 2, 2, 2, 0.5, 2, 0x8b5cf6);
                createPowerup(8, 3.5, 2, 'speed');
                
                createPlatform(12, 3, -2, 2, 0.5, 2, 0x3b82f6);
                createCoin(12, 5, -2);
                
                createMovingPlatform(16, 2, 0, 2, 0.5, 2, 0xfbbf24, 'x', 2);
                createEnemy(16, 3.5, 0);
                
                createPlatform(20, 4, 3, 2, 0.5, 2, 0x8b5cf6);
                createCoin(20, 6, 3);
                
                createMovingPlatform(24, 3, -3, 2, 0.5, 2, 0xfbbf24, 'y', 2);
                createPowerup(24, 5, -3, 'jump');
                
                createPlatform(28, 5, 0, 2, 0.5, 2, 0x3b82f6);
                createCoin(28, 7, 0);
                
                createPlatform(32, 6, 0, 3, 0.5, 3, 0x3b82f6);
                createGoal(36, 6, 0);
            } else if (level === 6) {
                // Nivel 6: Laberinto vertical
                createPlatform(5, 1, 0, 3, 0.5, 3, 0x3b82f6);
                createCoin(5, 3, 0);
                
                createPlatform(9, 2, 4, 3, 0.5, 3, 0x8b5cf6);
                createEnemy(9, 3.5, 4);
                createPowerup(9, 4, 4, 'shield');
                
                createMovingPlatform(13, 4, 0, 3, 0.5, 3, 0xfbbf24, 'z', 4);
                createCoin(13, 6, 0);
                
                createPlatform(17, 3, -4, 3, 0.5, 3, 0x8b5cf6);
                createEnemy(17, 4.5, -4);
                
                createMovingPlatform(21, 5, 0, 3, 0.5, 3, 0xfbbf24, 'x', 3);
                createCoin(21, 7, 0);
                createPowerup(21, 7.5, 0, 'invincible');
                
                createPlatform(25, 6, 4, 3, 0.5, 3, 0x3b82f6);
                createEnemy(25, 7.5, 4);
                
                createPlatform(29, 7, 0, 3, 0.5, 3, 0x8b5cf6);
                createCoin(29, 9, 0);
                
                createPlatform(33, 8, -3, 4, 0.5, 4, 0x3b82f6);
                createCoin(33, 10, -3);
                createCoin(33, 10, -1);
                
                createGoal(38, 8, -3);
            } else if (level === 7) {
                // Nivel 7: Final √©pico
                createPlatform(5, 1, 0, 3, 0.5, 3, 0x3b82f6);
                createPowerup(5, 2.5, 0, 'speed');
                
                createMovingPlatform(9, 2, 3, 2.5, 0.5, 2.5, 0xfbbf24, 'z', 3);
                createEnemy(9, 3.5, 3);
                
                createMovingPlatform(13, 3, -3, 2.5, 0.5, 2.5, 0xfbbf24, 'x', 3);
                createCoin(13, 5, -3);
                
                createPlatform(17, 4, 0, 2, 0.5, 2, 0x8b5cf6);
                createPowerup(17, 5.5, 0, 'jump');
                
                createMovingPlatform(21, 6, 4, 2.5, 0.5, 2.5, 0xfbbf24, 'y', 2);
                createEnemy(21, 8, 4);
                
                createPlatform(25, 5, -4, 2, 0.5, 2, 0x3b82f6);
                createCoin(25, 7, -4);
                
                createMovingPlatform(29, 7, 0, 2.5, 0.5, 2.5, 0xfbbf24, 'x', 4);
                createPowerup(29, 9, 0, 'invincible');
                
                createPlatform(33, 6, 3, 2, 0.5, 2, 0x8b5cf6);
                createEnemy(33, 7.5, 3);
                
                createMovingPlatform(37, 8, -2, 2.5, 0.5, 2.5, 0xfbbf24, 'z', 3);
                createCoin(37, 10, -2);
                
                createPlatform(41, 9, 0, 3, 0.5, 3, 0x3b82f6);
                createEnemy(41, 10.5, 0);
                
                createPlatform(45, 10, 0, 5, 0.5, 5, 0x22c55e);
                createCoin(45, 12, 0);
                createCoin(45, 12, 2);
                createCoin(45, 12, -2);
                createCoin(47, 12, 0);
                
                createGoal(50, 10, 0);
            }
        }

        function createPlatform(x, y, z, width, height, depth, color) {
            const geometry = new THREE.BoxGeometry(width, height, depth);
            const material = new THREE.MeshStandardMaterial({ color: color });
            const platform = new THREE.Mesh(geometry, material);
            platform.position.set(x, y, z);
            platform.receiveShadow = true;
            platform.castShadow = true;
            platform.userData.isPlatform = true;
            scene.add(platform);
            platforms.push(platform);
            return platform;
        }

        function createMovingPlatform(x, y, z, width, height, depth, color, axis, range) {
            const platform = createPlatform(x, y, z, width, height, depth, color);
            platform.userData.moving = true;
            platform.userData.axis = axis;
            platform.userData.range = range;
            platform.userData.startPos = { x, y, z };
            platform.userData.offset = 0;
            platform.userData.speed = 0.02;
            return platform;
        }

        function createCoin(x, y, z) {
            const geometry = new THREE.CylinderGeometry(0.3, 0.3, 0.1, 16);
            const material = new THREE.MeshStandardMaterial({ 
                color: 0xfbbf24,
                emissive: 0xfbbf24,
                emissiveIntensity: 0.5,
                metalness: 0.8,
                roughness: 0.2
            });
            const coin = new THREE.Mesh(geometry, material);
            coin.position.set(x, y, z);
            coin.rotation.x = Math.PI / 2;
            coin.userData.isCoin = true;
            coin.userData.rotation = 0;
            scene.add(coin);
            coins.push(coin);
        }

        function createPowerup(x, y, z, type) {
            const geometry = new THREE.SphereGeometry(0.4, 16, 16);
            let color, icon;
            
            switch(type) {
                case 'speed':
                    color = 0x00ffff; // Cyan
                    icon = '‚ö°';
                    break;
                case 'jump':
                    color = 0x00ff00; // Verde
                    icon = 'ü¶ò';
                    break;
                case 'shield':
                    color = 0x0080ff; // Azul
                    icon = 'üõ°Ô∏è';
                    break;
                case 'invincible':
                    color = 0xff00ff; // Magenta
                    icon = '‚≠ê';
                    break;
            }
            
            const material = new THREE.MeshStandardMaterial({ 
                color: color,
                emissive: color,
                emissiveIntensity: 0.7,
                metalness: 0.5,
                roughness: 0.3
            });
            const powerup = new THREE.Mesh(geometry, material);
            powerup.position.set(x, y, z);
            powerup.userData.isPowerup = true;
            powerup.userData.type = type;
            powerup.userData.icon = icon;
            powerup.userData.rotation = 0;
            scene.add(powerup);
            powerups.push(powerup);
        }

        function activatePowerup(type) {
            const duration = 8000; // 8 segundos
            const now = Date.now();
            
            activePowerups[type].active = true;
            activePowerups[type].endTime = now + duration;
            
            // Efecto visual en el jugador
            if (type === 'speed') {
                player.material.emissive = new THREE.Color(0x00ffff);
                player.material.emissiveIntensity = 0.5;
            } else if (type === 'jump') {
                player.material.emissive = new THREE.Color(0x00ff00);
                player.material.emissiveIntensity = 0.5;
            } else if (type === 'shield') {
                player.material.emissive = new THREE.Color(0x0080ff);
                player.material.emissiveIntensity = 0.5;
            } else if (type === 'invincible') {
                player.material.emissive = new THREE.Color(0xff00ff);
                player.material.emissiveIntensity = 0.8;
            }
            
            updatePowerupUI();
        }

        function updatePowerupUI() {
            const container = document.getElementById('activePowerups');
            container.innerHTML = '';
            
            const now = Date.now();
            let hasActive = false;
            
            for (let type in activePowerups) {
                if (activePowerups[type].active) {
                    const remaining = Math.ceil((activePowerups[type].endTime - now) / 1000);
                    if (remaining > 0) {
                        hasActive = true;
                        const icons = { speed: '‚ö°', jump: 'ü¶ò', shield: 'üõ°Ô∏è', invincible: '‚≠ê' };
                        const names = { speed: 'Velocidad', jump: 'Super Salto', shield: 'Escudo', invincible: 'Invencible' };
                        
                        const div = document.createElement('div');
                        div.className = 'powerup-active';
                        div.innerHTML = `
                            <span>${icons[type]} ${names[type]}</span>
                            <span class="powerup-timer">${remaining}s</span>
                        `;
                        container.appendChild(div);
                    } else {
                        activePowerups[type].active = false;
                        // Restaurar color del jugador si no hay otros powerups
                        if (!hasActivePowerup()) {
                            player.material.emissive = new THREE.Color(0x000000);
                            player.material.emissiveIntensity = 0;
                        }
                    }
                }
            }
        }

        function hasActivePowerup() {
            for (let type in activePowerups) {
                if (activePowerups[type].active) return true;
            }
            return false;
        }

        function createEnemy(x, y, z) {
            const geometry = new THREE.BoxGeometry(0.8, 0.8, 0.8);
            const material = new THREE.MeshStandardMaterial({ 
                color: 0xef4444,
                emissive: 0xef4444,
                emissiveIntensity: 0.3
            });
            const enemy = new THREE.Mesh(geometry, material);
            enemy.position.set(x, y, z);
            enemy.castShadow = true;
            enemy.userData.isEnemy = true;
            enemy.userData.rotation = 0;
            scene.add(enemy);
            enemies.push(enemy);
        }

        function createGoal(x, y, z) {
            const geometry = new THREE.CylinderGeometry(1, 1, 3, 16);
            const material = new THREE.MeshStandardMaterial({ 
                color: 0x22c55e,
                emissive: 0x22c55e,
                emissiveIntensity: 0.5
            });
            const goal = new THREE.Mesh(geometry, material);
            goal.position.set(x, y + 1.5, z);
            goal.userData.isGoal = true;
            scene.add(goal);
            platforms.push(goal);
        }

        function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            gameActive = true;
            startTime = Date.now();
            lives = 3;
            coinsCollected = 0;
            currentLevel = 1;
            player.position.set(0, 2, 0);
            playerVelocity.set(0, 0, 0);
            
            // Resetear power-ups
            for (let type in activePowerups) {
                activePowerups[type].active = false;
                activePowerups[type].endTime = 0;
            }
            player.material.emissive = new THREE.Color(0x000000);
            player.material.emissiveIntensity = 0;
            
            createLevel(1);
            updateUI();
            updatePowerupUI();
            animate();
        }

        function restartGame() {
            document.getElementById('gameOver').style.display = 'none';
            gameActive = true;
            startTime = Date.now();
            lives = 3;
            coinsCollected = 0;
            currentLevel = 1;
            player.position.set(0, 2, 0);
            playerVelocity.set(0, 0, 0);
            
            // Resetear power-ups
            for (let type in activePowerups) {
                activePowerups[type].active = false;
                activePowerups[type].endTime = 0;
            }
            player.material.emissive = new THREE.Color(0x000000);
            player.material.emissiveIntensity = 0;
            
            createLevel(1);
            updateUI();
            updatePowerupUI();
        }

        function nextLevel() {
            currentLevel++;
            if (currentLevel > 7) {
                endGame(true);
            } else {
                player.position.set(0, 2, 0);
                playerVelocity.set(0, 0, 0);
                createLevel(currentLevel);
                updateUI();
            }
        }

        function endGame(won = false) {
            gameActive = false;
            document.getElementById('gameOver').style.display = 'block';
            document.getElementById('gameOverTitle').textContent = won ? 'üéâ ¬°Victoria!' : 'üíÄ Game Over';
            document.getElementById('gameOverText').textContent = won ? 
                '¬°Has completado todos los niveles!' : 
                'Te quedaste sin vidas';
            document.getElementById('finalCoins').textContent = coinsCollected;
            document.getElementById('finalTime').textContent = Math.floor(elapsedTime / 1000);
        }

        function updatePhysics() {
            if (!gameActive) return;

            // Gravedad
            playerVelocity.y += gravity;

            // Movimiento horizontal con velocidad ajustada
            const forward = new THREE.Vector3();
            const right = new THREE.Vector3();
            camera.getWorldDirection(forward);
            forward.y = 0;
            forward.normalize();
            right.crossVectors(forward, new THREE.Vector3(0, 1, 0)).normalize();

            const currentSpeed = getCurrentMoveSpeed();

            if (keys['w']) {
                playerVelocity.x += forward.x * currentSpeed;
                playerVelocity.z += forward.z * currentSpeed;
            }
            if (keys['s']) {
                playerVelocity.x -= forward.x * currentSpeed;
                playerVelocity.z -= forward.z * currentSpeed;
            }
            if (keys['a']) {
                playerVelocity.x -= right.x * currentSpeed;
                playerVelocity.z -= right.z * currentSpeed;
            }
            if (keys['d']) {
                playerVelocity.x += right.x * currentSpeed;
                playerVelocity.z += right.z * currentSpeed;
            }

            // Salto con fuerza ajustada
            if (keys[' '] && canJump && !isJumping) {
                playerVelocity.y = getCurrentJumpForce();
                isJumping = true;
                canJump = false;
            }

            // Fricci√≥n
            playerVelocity.x *= friction;
            playerVelocity.z *= friction;

            // Aplicar velocidad
            player.position.add(playerVelocity);

            // Colisiones con plataformas
            canJump = false;
            platforms.forEach(platform => {
                if (checkCollision(player, platform)) {
                    // Colisi√≥n desde arriba
                    if (playerVelocity.y < 0) {
                        player.position.y = platform.position.y + platform.geometry.parameters.height / 2 + 0.5;
                        playerVelocity.y = 0;
                        isJumping = false;
                        canJump = true;

                        // Si es plataforma m√≥vil, mover al jugador con ella
                        if (platform.userData.moving) {
                            const delta = platform.userData.lastDelta || { x: 0, y: 0, z: 0 };
                            player.position.x += delta.x;
                            player.position.y += delta.y;
                            player.position.z += delta.z;
                        }
                    }

                    // Meta
                    if (platform.userData.isGoal) {
                        nextLevel();
                    }
                }
            });

            // Colisi√≥n con monedas
            coins.forEach((coin, index) => {
                const distance = player.position.distanceTo(coin.position);
                if (distance < 1) {
                    scene.remove(coin);
                    coins.splice(index, 1);
                    coinsCollected++;
                    updateUI();
                }
            });

            // Colisi√≥n con power-ups
            powerups.forEach((powerup, index) => {
                const distance = player.position.distanceTo(powerup.position);
                if (distance < 1) {
                    scene.remove(powerup);
                    powerups.splice(index, 1);
                    activatePowerup(powerup.userData.type);
                }
            });

            // Colisi√≥n con enemigos
            enemies.forEach(enemy => {
                const distance = player.position.distanceTo(enemy.position);
                if (distance < 1) {
                    // Protecci√≥n con shield o invincible
                    if (activePowerups.shield.active) {
                        // Desactivar escudo pero no perder vida
                        activePowerups.shield.active = false;
                        updatePowerupUI();
                    } else if (!activePowerups.invincible.active) {
                        respawn();
                    }
                }
            });

            // Ca√≠da
            if (player.position.y < -10) {
                respawn();
            }

            // Actualizar tiempo
            elapsedTime = Date.now() - startTime;
            document.getElementById('time').textContent = Math.floor(elapsedTime / 1000);
            
            // Actualizar UI de power-ups
            updatePowerupUI();
        }

        function checkCollision(obj1, obj2) {
            const box1 = new THREE.Box3().setFromObject(obj1);
            const box2 = new THREE.Box3().setFromObject(obj2);
            return box1.intersectsBox(box2);
        }

        function respawn() {
            lives--;
            updateUI();
            if (lives <= 0) {
                endGame(false);
            } else {
                player.position.set(0, 2, 0);
                playerVelocity.set(0, 0, 0);
            }
        }

        function updateUI() {
            document.getElementById('coins').textContent = coinsCollected;
            document.getElementById('lives').textContent = lives;
            document.getElementById('level').textContent = currentLevel;
        }

        function animate() {
            if (!gameActive) return;
            requestAnimationFrame(animate);

            updatePhysics();

            // Animar monedas
            coins.forEach(coin => {
                coin.userData.rotation += 0.05;
                coin.rotation.z = coin.userData.rotation;
            });

            // Animar power-ups
            powerups.forEach(powerup => {
                powerup.userData.rotation += 0.03;
                powerup.rotation.y = powerup.userData.rotation;
                powerup.position.y += Math.sin(powerup.userData.rotation * 2) * 0.01;
            });

            // Animar enemigos
            enemies.forEach(enemy => {
                enemy.userData.rotation += 0.02;
                enemy.rotation.y = enemy.userData.rotation;
            });

            // Mover plataformas m√≥viles
            platforms.forEach(platform => {
                if (platform.userData.moving) {
                    platform.userData.offset += platform.userData.speed;
                    const offset = Math.sin(platform.userData.offset) * platform.userData.range;
                    
                    const oldPos = { x: platform.position.x, y: platform.position.y, z: platform.position.z };
                    
                    if (platform.userData.axis === 'x') {
                        platform.position.x = platform.userData.startPos.x + offset;
                    } else if (platform.userData.axis === 'y') {
                        platform.position.y = platform.userData.startPos.y + offset;
                    } else if (platform.userData.axis === 'z') {
                        platform.position.z = platform.userData.startPos.z + offset;
                    }
                    
                    platform.userData.lastDelta = {
                        x: platform.position.x - oldPos.x,
                        y: platform.position.y - oldPos.y,
                        z: platform.position.z - oldPos.z
                    };
                }
            });

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        init();
    </script>
</body>
</html>